<!DOCTYPE html><html lang="en"><head><title>server</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="server"><meta name="groc-project-path" content="server.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">server.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="point-dentre-du-serveur">Point d’entrée du serveur</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le mode strict c’est le bien…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On dope <code>String</code> avec des accesseurs de coloration, par exemple <code>.green</code>,
pour avoir de jolis affichages en console…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'colors'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>J’aime bien coller tous mes <code>require</code> (ou presque) en haut, ça permet
d&#39;avoir une vue claire des dépendances…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> bodyParser    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">var</span> cookieSession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-session'</span>);
<span class="hljs-keyword">var</span> csrf          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'csurf'</span>);
<span class="hljs-keyword">var</span> express       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> flash         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-flash'</span>);
<span class="hljs-keyword">var</span> http          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> morgan        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>);
<span class="hljs-keyword">var</span> passport      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">var</span> path          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> serveStatic   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'serve-static'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="noyau-de-l39appli">Noyau de l&#39;appli</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>On crée une « appli » serveur, grâce à <a href="http://expressjs.com/">Express</a></li>
</ol></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> app = express();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>On crée un serveur HTTP qui lui délègue l&#39;applicatif</li>
</ol></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> server = http.createServer(app);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="config-de-base">Config de base</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le port d&#39;écoute sera celui défini en environnement ou, à défaut, 3000.</p></div></div><div class="code"><div class="wrapper">app.set(<span class="hljs-string">'port'</span>, process.env.PORT || <span class="hljs-number">3000</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Et on utilisera Jade pour le templating (du coup, Express cherchera, pour
une vue <code>&quot;comments/new&quot;</code>, le fichier <code>views/comments/new.jade</code>).</p></div></div><div class="code"><div class="wrapper">app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Express récupère dans son réglage <code>&#39;env&#39;</code> la valeur de la variable d’environnement
<code>NODE_ENV</code>, laquelle est à <code>&#39;development&#39;</code> par défaut.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> devMode = <span class="hljs-string">'development'</span> === app.get(<span class="hljs-string">'env'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="middlewares">Middlewares</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le module <a href="https://github.com/expressjs/morgan">morgan</a> gère un log formatable en console.
Si on voulait du gros log de furieux, on utiliserait <a href="https://github.com/trentm/node-bunyan">Bunyan</a>
ou <a href="https://github.com/flatiron/winston">Winston</a>.</p></div></div><div class="code"><div class="wrapper">app.use(morgan(devMode ? <span class="hljs-string">'dev'</span> : <span class="hljs-string">'common'</span>));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On maintient nos sessions côté client, dans des cookies signés, grâce à
<a href="https://github.com/expressjs/cookie-session">cookie-session</a>.  Ici on n’utilise
pas de clés rotatives, juste une (<code>secret</code>).  Si vous préférez persister vos sessions
côté serveur, jetez un œil à <a href="https://github.com/expressjs/session">express-session</a>
par-dessus <a href="https://github.com/visionmedia/connect-redis">connect-redis</a>, par exemple.</p></div></div><div class="code"><div class="wrapper">app.use(cookieSession({ name: <span class="hljs-string">'node-pw14:session'</span>, secret: <span class="hljs-string">"Node.js c’est de la balle !"</span> }));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On n’est intéressés que par les corps de requête de type formulaires simples
(&quot;URL-encoded&quot;), donc on se limite à cette analyse-là.  C’est
<a href="https://github.com/expressjs/body-parser">body-parser</a> qui sait gérer ça.</p></div></div><div class="code"><div class="wrapper">app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">true</span> }));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On se protège contre les attaques <a href="https://fr.wikipedia.org/wiki/Cross-Site_Request_Forgery">CSRF</a>
avec ce brave <a href="https://github.com/expressjs/csurf">csurf</a>.
On fournira le token à inclure par les formulaires dans un paramètre <code>_csrf</code> au travers
de notre <a href="./helpers/main.html">helper</a>.</p></div></div><div class="code"><div class="wrapper">app.use(csrf());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Afin de pouvoir définir et relire des contenus temporaires (au travers d&#39;une redirection,
notamment), on utilise <a href="https://github.com/jaredhanson/connect-flash">connect-flash</a>,
qui équipe les requêtes de la méthode <code>flash(…)</code>.</p></div></div><div class="code"><div class="wrapper">app.use(flash());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Tout fichier statique présent dans le sous-dossier <code>public/</code> peut être servi automatiquement,
avec le bon type MIME et tout…  Merci <a href="https://github.com/expressjs/serve-static">serve-static</a>.</p></div></div><div class="code"><div class="wrapper">app.use(serveStatic(path.join(__dirname, <span class="hljs-string">'public'</span>)));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pour l’authentification, on utilise <a href="http://passportjs.org/">Passport</a>.  Celui-ci requiert au
moins le <em>middleware</em> fourni par <code>passport.initialize()</code> pour étendre les requêtes avec les
propriétés (ex. <code>user</code>) et méthodes (ex. <code>isAuthenticated()</code>) nécessaires, ainsi que, si on
utilise les sessions pour persister l&#39;authentification, celui fourni par <code>passport.session()</code>,
qui s&#39;occupera de (dé)sérialiser un objet représentant l&#39;utilisateur courant.  Les <em>hooks</em> pour
ce faire seront dans notre <a href="./controllers/users.html">contrôleur utilisateurs</a>.  Il est
évidemment nécessaire que <code>req.session</code> soit déjà mis en place, donc ici que <code>cookieSession</code>
soit enregistré par <code>app.use(…)</code> avant <code>passport.session()</code>.</p></div></div><div class="code"><div class="wrapper">app.use(passport.initialize());
app.use(passport.session());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="variables-de-vue-par-dfaut">Variables de vue par défaut</h2>
<p>Les templates lisent leurs variables depuis trois sources.  Par ordre de priorité croissante,
ce sont :</p>
<ol>
<li><code>app.locals</code> (app-wide, généralement défini une bonne fois, comme ici)</li>
<li><code>res.locals</code> (response-wide, souvent rempli par des middlewares)</li>
<li>L’objet/hash fourni en 2ème argument à <code>res.render</code> (vue seule)</li>
</ol></div></div><div class="code"><div class="wrapper">app.locals.title = <span class="hljs-string">'Node.js démystifié'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>La variable <code>pretty</code> a un rôle particulier dans <a href="http://jade-lang.com/">Jade</a> : si elle est
<em>truthy</em> (ex. <code>true</code>, <code>42</code>, <code>&#39;yes&#39;</code>, etc.), elle déclenche un traitement supplémentaire
d&#39;indentation du HTML produit.  Par défaut, Jade n&#39;injecte aucun <em>whitespace</em> et produit un
HTML minifié, ce qui est top pour la prod, mais pas génial en dev…</p></div></div><div class="code"><div class="wrapper">app.locals.pretty = devMode;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="helpers-amp-contrleurs">Helpers &amp; Contrôleurs</h2>
<p>On déporte les différents « modules » applicatifs dans leurs modules propres, pour conserver
un code modulaire, plus lisible et plus pratique à maintenir.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers/main'</span>)(app);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/users'</span>)(app);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/home'</span>)(app);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/comments'</span>)(app);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/web-sockets'</span>)(server);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dmarrage-du-serveur">Démarrage du serveur</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On s’assure que la connexion MongoDB est ouverte…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'./models/connection'</span>)(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On le dit… (notez le <code>.green</code> fourni par <code>colors</code> à la fin)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'✔︎ Connected to mongoDB database'</span>.green);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…et on lance le serveur HTTP sur le port qui va bien.
Un simple Ctrl+C (ou signal SIGINT passé autrement) arrêtera tout ça proprement.</p></div></div><div class="code"><div class="wrapper">  server.listen(app.get(<span class="hljs-string">'port'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'✔︎︎ Express server listening on http://localhost:%d/'</span>.green, app.get(<span class="hljs-string">'port'</span>));
  });
});</div></div></div></div></body></html>