<!DOCTYPE html><html lang="en"><head><title>controllers/comments</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="controllers/comments"><meta name="groc-project-path" content="controllers/comments.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">controllers/comments.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="contrleur--commentaires">Contrôleur : Commentaires</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le mode strict c’est le bien…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="mise-en-place">Mise en place</h2>
<p>Notre module exporte une fonction qui configure le contrôleur en
enregistrant les middlewares et routes nécessaires.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commentsController</span><span class="hljs-params">(app)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Middleware exigeant l’authentification.</p></div></div><div class="code"><div class="wrapper">  app.use(<span class="hljs-string">'/comments'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On a bien un <code>req.user</code> ? Cool ! On passe à la suite.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (req.user) {
      <span class="hljs-keyword">return</span> next();
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ah, on n‘en a pas ?  Un p&#39;tit message et direct à la page de login.</p></div></div><div class="code"><div class="wrapper">    req.flash(<span class="hljs-string">'info'</span>, <span class="hljs-string">'Tu dois être authentifié(e) pour accéder aux commentaires.'</span>);
    res.redirect(<span class="hljs-string">'/get-in'</span>);
  });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Routes : listing, formulaire d&#39;ajout, création à proprement parler.
<strong>Note</strong> : en déportant chaque action dans sa déclaration de fonction propre plus loin
dans le module, on conserve une « table de routage » toute concise, bien lisible.
Nettement mieux qu’en collant les fonctions de rappel à la volée…</p></div></div><div class="code"><div class="wrapper">  app.get (<span class="hljs-string">'/comments'</span>,     listComments);
  app.get (<span class="hljs-string">'/comments/new'</span>, newComment);
  app.post(<span class="hljs-string">'/comments'</span>,     createComment);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="gestionnaires-de-routes">Gestionnaires de routes</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>En temps normal je colle mes <code>require</code> tout en haut, mais pour un contrôleur/helper
j’aime bien commencer plutôt par la fonction d&#39;enregistrement, et laisser le corps du
code opérationnel ensuite.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Comment = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/comment'</span>);
<span class="hljs-keyword">var</span> realTime = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./web-sockets'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="cr-ation-post-comments-new-">Création (<code>POST /comments/new</code>)</h3></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createComment</span><span class="hljs-params">(req, res)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On passe par la méthode statique <code>create</code> fourni par <a href="http://mongoosejs.com/">Mongoose</a>
sur ses modèles, qui renvoie une <a href="http://www.html5rocks.com/fr/tutorials/es6/promises/">promesse</a>,
ce qui nous permet de chaîner proprement les traitements en cas de succès
et d&#39;échec, même s&#39;ils sont asynchrone, sans imbriquer à n&#39;en plus finir des
fonctions de rappel…</p></div></div><div class="code"><div class="wrapper">  Comment.create({
    author: req.user.id,
    text: req.body.text
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(comment)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On va notifier tout le monde du nouveau commentaire grâce aux Web Sockets.
Pour ça, on va faire un <em>rendering</em> du fragment Jade associé directement dans une
<code>String</code> (au lieu que ce soit dans notre corps de réponse) : il suffit de passer une
fonction de rappel en 3ème argument à <code>res.render</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">var</span> notif = comment.toJSON();
    notif.author = req.user;
    res.render(<span class="hljs-string">'comments/_comment'</span>, { comment: notif }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, html)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Bon, si on voulait vraiment se blinder, on vérifierait et traiterait une
éventuelle erreur (<code>err</code>) ici, mais bon…</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (html) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>« Hey tout le monde, y&#39;a un nouveau commentaire ! » (avec le HTML en complément)
Cet événement sera écouté <a href="../public/node-demo.html">côté client</a>.</p></div></div><div class="code"><div class="wrapper">        realTime.sockets.emit(<span class="hljs-string">'new-comment'</span>, html.trim());
      }
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Bon, bin en tout cas, tout s&#39;est bien passé, alors on le dit et on redirige
sur le listing (en vertu du <a href="http://fr.wikipedia.org/wiki/Post-Redirect-Get">Post-Redirect-Get</a>).</p></div></div><div class="code"><div class="wrapper">    req.flash(<span class="hljs-string">'success'</span>, <span class="hljs-string">'Ton commentaire a bien été ajouté.'</span>);
    res.redirect(<span class="hljs-string">'/comments'</span>);
  }).then(<span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Si on est ici, soit le <code>create</code> a échoué, soit on a fait une connerie dans le <code>then</code>
(la branche de succès du <code>create</code>).  Logons déjà ça en console serveur…</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">console</span>.error(error);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…et couinons auprès de l&#39;utilisateur.  Comme on va refaire le <em>rendering</em> directement,
sans redirection, pas besoin d’écrire dans le flash pour relire immédiatement : autant
définir la variable de vue directement…</p></div></div><div class="code"><div class="wrapper">    res.locals.flash = { error: <span class="hljs-string">'Si tu mettais un texte ce serait mieux…'</span> };</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>HTTP code 400 : Bad Request (toujours utiliser un code approprié)</p></div></div><div class="code"><div class="wrapper">    res.status(<span class="hljs-number">400</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…après quoi c’est comme un affichage normal de formulaire d&#39;ajout, alors déléguons !</p></div></div><div class="code"><div class="wrapper">    newComment(req, res);
  });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="listing-get-comments-">Listing (<code>GET /comments</code>)</h3></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listComments</span><span class="hljs-params">(req, res)</span> </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>C’est nous qui avons <a href="../models/comment.html">défini</a> <code>getAll</code> comme méthode statique
du modèle de commentaire.  C’est une fine surcouche de <code>.find</code>.</p></div></div><div class="code"><div class="wrapper">  Comment.getAll()
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(comments)</span> </span>{
    res.render(<span class="hljs-string">'comments/index'</span>, { title: <span class="hljs-string">'Commentaires'</span>, comments: comments });
  });
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="formulaire-d-ajout-get-comments-new-">Formulaire d’ajout (<code>GET /comments/new</code>)</h3></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newComment</span><span class="hljs-params">(req, res)</span> </span>{
  res.render(<span class="hljs-string">'comments/new'</span>, { title: <span class="hljs-string">'Nouveau commentaire'</span> });
}</div></div></div></div></body></html>